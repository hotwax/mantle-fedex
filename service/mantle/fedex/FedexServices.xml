<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!--Default Authentication Service for Main services -->
        <!--Takes Connection Details and returns requestMap-->
        <service verb="set" noun="Connection">
            <in-parameters>
                <parameter name="method"/>
                <parameter name="connectUrl"/>
                <parameter name="contentType"/>
                <parameter name="requestMap" type="Map"/>
                <parameter name="requestPath"/>
                <parameter name="apiTokenValue"/>
            </in-parameters>
            <out-parameters>
                <parameter name="responseMap"/>
            </out-parameters>
            <actions>
                <script><![CDATA[
                      import org.moqui.util.RestClient;
                      import groovy.json.JsonSlurper;
                         def connectUrl=connectUrl;
                         RestClient restClient = ec.service.rest()
                         restClient.method(method)
                         restClient.uri(connectUrl)
                         restClient.contentType(contentType)
                         if(requestPath!=null && requestPath!="")
                         {
                            restClient.text(requestPath)
                         }
                         if(apiTokenValue!=null)
                         {
                              restClient.addHeader("Authorization", "${apiTokenValue}")
                         }
                         if(requestMap!=null)
                         {
                             restClient.jsonObject(requestMap)
                         }
                         RestClient.RestResponse restResponse = restClient.call()
                         /*Checking Response Status Code is not verified yet*/
                         if (restResponse.statusCode < 200 || restResponse.statusCode > 300) {
                            errMsgMap = (Map) new JsonSlurper().parseText(restResponse.text())
                            ec.logger.warn(restResponse.text())
                            return responseMap
                        }
                        responseMap = restResponse.jsonObject()
                     ]]>
                </script>
                <log message="In set#Connection service, returned: ${responseMap}"/>
            </actions>
    </service>
    <!--Default Authentication Service for Main services -->
        <!--Set/Generate new Fedex API Token-->
        <service verb="store" noun="FedexTokenDetails">
            <description>
                Test Credentials Are Predefined so this service is outdated.
            </description>
                 <in-parameters>
                    <!--Adds grantType,clientId, clientSecret and accountNumber-->
                        <auto-parameters entity-name="FedexTokenDetails" include="nonpk">
                            <exclude field-name="lastUpdatedStamp"/>
                        </auto-parameters>
                </in-parameters>
                <out-parameters>
                    <parameter name="tokenId"/>
                </out-parameters>
                <actions>
                    <entity-find-one entity-name="FedexTokenDetails" value-field="fedexTokenDetails">
                        <field-map field-name="tokenId" value="1"/>
                    </entity-find-one>
                    <set field="tokenId" value="1"/>
                    <!--Create new token/Update current token-->
                    <if condition="fedexTokenDetails==null">
                        <entity-make-value entity-name="FedexTokenDetails" value-field="fedexTokenDetails"/>
                        <set field="tokenId" value="1"/>
                        <set field="fedexTokenDetails.tokenId" from="tokenId"/>
                        <set field="fedexTokenDetails.grantType" from="grantType"/>
                        <set field="fedexTokenDetails.clientId" from="clientId"/>
                        <set field="fedexTokenDetails.clientSecret" from="clientSecret"/>
                        <set field="fedexTokenDetails.accountNumber" from="accountNumber"/>
                        <entity-create value-field="fedexTokenDetails"/>
                    </if>
                    <else>
                        <set field="fedexTokenDetails.grantType" from="grantType"/>
                        <set field="fedexTokenDetails.clientId" from="clientId"/>
                        <set field="fedexTokenDetails.clientSecret" from="clientSecret"/>
                        <set field="fedexTokenDetails.accountNumber" from="accountNumber"/>
                        <entity-update value-field="fedexTokenDetails"/>
                    </else>
            </actions>
        </service>

    <!--Validate Postal Address-->
    <service verb="validate" noun="PostalAddress">
        <description>Credentials are stored in Demo Data.Demo: ContactMechId="Fedex_Contact_Ivan",ShippingGatewayConfigId="Fedex Integration"
        </description>

        <in-parameters>
            <parameter name="contactMechId" required="true"/>
            <parameter name="partyId" required="true"/>
            <parameter name="shippingGatewayConfigId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="responseMap" type="Map"/>
        </out-parameters>
        <actions>

            <!--Searching FedexApiToken-->
            <entity-find-one entity-name="ShippingGatewayOption" value-field="apiTokenOpt">
                <field-map field-name="shippingGatewayConfigId" from="shippingGatewayConfigId"/>
                <field-map field-name="optionEnumId" value="FedexApiToken"/>
            </entity-find-one>
            <if condition="apiTokenOpt.optionValue"><log level="warn" message="Shipping gateway ${shippingGatewayConfigId} has no FedexApiToken, not validating address"/><return/></if>

            <!--Converting Address Data to JSON Request Map-->
            <service-call name="mantle.fedex.FedexServices.get#AddressMap" in-map='[contactMechId:contactMechId, partyId:partyId]'
                          out-map='addressMap'/>
            <if condition="!addressMap"><return/></if>

            <!--Setting Connection With Fedex-->
            <service-call name="mantle.fedex.FedexServices.set#Connection"
                          in-map="[method:'POST',connectUrl:'https://apis-sandbox.fedex.com/address/v1/addresses/resolve',
                                   contentType:'application/json',requestMap:addressMap.requestMap,apiTokenValue:apiTokenOpt.optionValue]"
                          out-map="responseMap"/>
            <log message="In validate#PostalAddress service, returned ${responseMap.responseMap}"/>
            <set field="responseMap" from="responseMap.responseMap"/>
        </actions>
    </service>

    <!--Return Address in form of Required Request Map-->
    <service verb="get" noun="AddressMap">
        <in-parameters>
            <parameter name="contactMechId"></parameter>
            <parameter name="partyId"></parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="requestMap" type="Map"/>
        </out-parameters>
        <actions>
            <!--Validating ContactMech Id-->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddress">
                <field-map field-name="contactMechId" from="contactMechId"/>
            </entity-find-one>
            <if condition="!postalAddress">
                <return type="danger" message="Invalid Contact Mech ID"/>
            </if>
            <!--Creating Request Map From given Postal Address-->
            <entity-find-one entity-name="Geo" value-field="geoStateData">
                <field-map field-name="geoId" from="postalAddress.stateProvinceGeoId"/>
                <select-field field-name="geoCodeAlpha2"/>
            </entity-find-one>
            <entity-find-one entity-name="Geo" value-field="geoCountryData">
                <field-map field-name="geoId" from="postalAddress.countryGeoId"/>
                <select-field field-name="geoCodeAlpha2"/>
            </entity-find-one>
            <set field="adrs" from="streetLines:[postalAddress.address1],
                                    city:postalAddress.city,
                                    stateOrProvinceCode:geoStateData.geoCodeAlpha2,
                                    countryCode:geoCountryData.geoCodeAlpha2,
                                    postalCode:postalAddress.postalCode" type="NewMap"/>
            <set field="requestMap" from="[addressesToValidate:[[address:adrs]]]" type="NewMap"/>
            <set field="validContactMechId" value="true"/>
            <log message="In get#AddressMap service, returned ${requestMap}=============="/>
        </actions>
    </service>
    <!--RateAndTrasitTime Service-->
    <service verb="get" noun="OrderShippingRate">
        <description>Remove accountNumber tag, it will be automatically added.</description>
        <in-parameters>
            <parameter name="shippingGatewayConfigId" required="true"/>
            <parameter name="requestMap" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="responseMap" required="true"/>
        </out-parameters>
        <actions>

            <!--Searching FedexApiToken-->
            <entity-find-one entity-name="ShippingGatewayOption" value-field="apiTokenOpt">
                <field-map field-name="shippingGatewayConfigId" from="shippingGatewayConfigId"/>
                <field-map field-name="optionEnumId" value="FedexApiToken"/>
            </entity-find-one>
            <if condition="apiTokenOpt.optionValue"><log level="warn" message="Shipping gateway ${shippingGatewayConfigId} has no FedexApiToken, not getting rates"/><return/></if>

            <!--Setting Connection With Fedex-->
            <service-call name="mantle.fedex.FedexServices.set#Connection"
                          in-map="[method:'POST',connectUrl:'https://apis-sandbox.fedex.com/rate/v1/rates/quotes',
                                   contentType:'application/json',requestMap:requestMap,
                                   apiTokenValue:apiTokenOpt.optionValue,xLocale:'en-US']"
                          out-map="responseMap"/>
            <log message="In get#OrderShippingRate, returned ${responseMap.responseMap}=============="/>
            <set field="responseMap" from="responseMap.responseMap"/>
        </actions>
    </service>
</services>