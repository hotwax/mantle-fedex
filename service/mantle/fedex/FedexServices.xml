<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!--Default Authentication Service for Main services -->
        <!--Takes Connection Details and returns requestMap-->
        <service verb="set" noun="Connection">
            <in-parameters>
                <parameter name="method"/>
                <parameter name="connectUrl"/>
                <parameter name="contentType"/>
                <parameter name="requestMap" type="Map"/>
                <parameter name="requestPath"/>
                <parameter name="apiTokenValue"/>
            </in-parameters>
            <out-parameters>
                <parameter name="responseMap"/>
            </out-parameters>
            <actions>
                <script><![CDATA[
                      import org.moqui.util.RestClient;
                      import groovy.json.JsonSlurper;
                         def connectUrl=connectUrl;
                         RestClient restClient = ec.service.rest()
                         restClient.method(method)
                         restClient.uri(connectUrl)
                         restClient.contentType(contentType)
                         if(requestPath!=null && requestPath!="")
                         {
                            restClient.text(requestPath)
                         }
                         if(apiTokenValue!=null)
                         {
                              restClient.addHeader("Authorization", "${apiTokenValue}")
                         }
                         if(requestMap!=null)
                         {
                             restClient.jsonObject(requestMap)
                         }
                         RestClient.RestResponse restResponse = restClient.call()
                         /*Checking Response Status Code is not verified yet*/
                         if (restResponse.statusCode < 200 || restResponse.statusCode > 300) {
                            errMsgMap = (Map) new JsonSlurper().parseText(restResponse.text())
                            ec.logger.warn(restResponse.text())
                            return responseMap
                        }
                        responseMap = restResponse.jsonObject()
                     ]]>
                </script>
            <log message="In set#Connection service, returned: ${responseMap}"/>
            </actions>
        </service>
    <!--Default Authentication Service for Main services -->
        <!--Set/Generate new Fedex API Token-->
        <service verb="store" noun="FedexTokenDetails">
            <description>
                Test Credentials Are Predefined so this service is outdated.
            </description>
                 <in-parameters>
                    <!--Adds grantType,clientId, clientSecret and accountNumber-->
                        <auto-parameters entity-name="FedexTokenDetails" include="nonpk">
                            <exclude field-name="lastUpdatedStamp"/>
                        </auto-parameters>
                </in-parameters>
                <out-parameters>
                    <parameter name="tokenId"/>
                </out-parameters>
                <actions>
                    <entity-find-one entity-name="FedexTokenDetails" value-field="fedexTokenDetails">
                        <field-map field-name="tokenId" value="1"/>
                    </entity-find-one>
                    <set field="tokenId" value="1"/>
                    <!--Create new token/Update current token-->
                    <if condition="fedexTokenDetails==null">
                        <entity-make-value entity-name="FedexTokenDetails" value-field="fedexTokenDetails"/>
                        <set field="tokenId" value="1"/>
                        <set field="fedexTokenDetails.tokenId" from="tokenId"/>
                        <set field="fedexTokenDetails.grantType" from="grantType"/>
                        <set field="fedexTokenDetails.clientId" from="clientId"/>
                        <set field="fedexTokenDetails.clientSecret" from="clientSecret"/>
                        <set field="fedexTokenDetails.accountNumber" from="accountNumber"/>
                        <entity-create value-field="fedexTokenDetails"/>
                    </if>
                    <else>
                        <set field="fedexTokenDetails.grantType" from="grantType"/>
                        <set field="fedexTokenDetails.clientId" from="clientId"/>
                        <set field="fedexTokenDetails.clientSecret" from="clientSecret"/>
                        <set field="fedexTokenDetails.accountNumber" from="accountNumber"/>
                        <entity-update value-field="fedexTokenDetails"/>
                    </else>
            </actions>
        </service>

</services>